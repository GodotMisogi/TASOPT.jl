Element Assembly Core {
	
	// Assembly level elements for solution control, interfacing, and power setting
	Option switchDes {
		description = "Determines if the engine core assembly is in design or off-design mode";
		IOstatus = "input";
		rewritableValues = FALSE;
		trigger = TRUE;
		allowedValues = {"DESIGN","OFFDESIGN"};
	}
    // ------------------------------
    // Compressor CmpH
    // ------------------------------
    Element Compressor CmpH
    {
		// ASK: Why does the TEsys include S_map values??
		PRdes    = 9.369;
		effDes   = 0.8723;
		// Sh_O.inertia   = 10.;     // slugs-ft**2.
		// #include "hpcCFM56_2.map"
		// #include "hpcCFM56.map"
		#include "hpcCFM56_linear.map"
		
		// Independent ind_CmpH_eff { varName = "effDes";}
		

		// ASK: what are these bleedout ports??
		InterStageBleedOutPort  Fl_B_CH
		{
			//switchFlow = "ABSOLUTE"
			fracBldWork	= 0.5;
			fracBldP = 0.5;
			fracBldW = 0.020274;
		}		
		InterStageBleedOutPort  Fl_B_NC
		{
			//switchFlow = "ABSOLUTE";
			fracBldWork	= 0.5;
			fracBldP = 0.5;
			fracBldW = 0.050708;
		}	
		
		// Customer Interstage HPC bleed
		InterStageBleedOutPort  Fl_B027
		{
			//switchFlow = "ABSOLUTE";
			fracBldWork	= 0.5;
			fracBldP = 0.5;
			// Wbld = 2.35;
			
		}
		Fl_O.MNdes = 0.25;
    }

    // ------------------------------
    // Bleed B030
    // ------------------------------
    Element Bleed B030
    {

		// ASK: why is the chargeable port not 0 in this case, but is 0 in TE??
		// Turbine Cooling and Leakage Air (TCLA) stream 1 
		// conisdered NON CHARGEABLE (connects to turbine inlet)
		BleedOutPort TCLA_NC {	              
			fracW = 0.1675;  //fracW = Ratio of bleed flow to Bleed element inlet flow
		}	
		// Turbine Cooling and Leakage Air (TCLA) stream 2 
		//considered CHARGEABLE (connects to turbine exit)
		BleedOutPort TCLA_CH {	              
			fracW = 0.100; //fracW = Ratio of bleed flow to Bleed element inlet flow
		} 

// ASK: What is this??
		BleedOutPort Fl_B030B
        {
            hscale = 1.0;
            fracW = 0.0;
        }
		Fl_O.MNdes = 0.3;
    }
    // ------------------------------
    // Duct Diffuser
    // ------------------------------
    
	// ASK: why is there a duct here but not in the TEsys??
		// why is dPqP not specified??
	Element Duct D031
    {

        Fl_O.MNdes = 0.3;
    }
    // ------------------------------
    // FuelStart FusEng
    // ------------------------------
    Element FuelStart FusEng
    {
		// fuelType = "Jet-A(L)";
		// Wfuel = 1.4;
		Wfuel = 0.09 * 120 * 430/LHV;
	
		 // ------------GasTab------------
		//  if( THERMPACKAGE == "GasTbl")
		//  {
		// 	cout<<"------------------------"<<endl;	
		// 	cout<<"Using "<<THERMPACKAGE<<endl;
		// 	cout<<"------------------------"<<endl;
		// 	LHV_in = 18700;//18384;//  // 1MJ/kg = 429.923 BTU/lbm 18700.0;
		// 	// Tref = 536.67; // 518.67 (59 F) if GASTAB, 536.67 (77 F) otherwise
		// 	// hFuel = 10;
		// 	setOption("switchGasTblOpt", "GASEQL2");
		// 	//setOption("switchGasTblOpt", "GASTAB");
		//  }
		//  //------------------------------	 
		//  // ------------JANAF------------
		//  if( THERMPACKAGE == "Janaf")
		//  {
		// 	cout<<"------------------------"<<endl;	
		// 	cout<<"Using "<<THERMPACKAGE<<endl;
		// 	cout<<"------------------------"<<endl;
		// 	LHV_in = 18700;
		// 	Carbon = 1.;
		// 	Hydrogen = .15598;
		// 	hFuel = .481*( 536.67 - 529.67 );
		//  }
		//  //------------------------------
		//  // ------------C E A------------
		//  if( THERMPACKAGE == "CEA")
		//  {
		// 	cout<<"------------------------"<<endl;	
		// 	cout<<"Using "<<THERMPACKAGE<<endl;
		// 	cout<<"------------------------"<<endl;
		// 	fuelType = "Jet-A(g)";
		// 	hFuel = -699.4;
		//  }
		 //------------------------------
		
        // HERE IS WHERE THE INDP Variable is set.		
        // Independent ind_Wfuel { varName = "Wfuel";}// autoSetup = TRUE;}

    }
    // ------------------------------
    // Burner BrnPri
    // ------------------------------
    Element Burner BrnPri
    {
        dPqP_dmd     = 0.054;
        effBase      = 1.;//0.99;
        setOption("switchBurn", "WFUEL");
		Fl_O.MNdes = 0.1;

		real EINOx = 0;

		void postexecute(){
			// Calcualte EINOx based on P3T3 method calibrated to CFM56-5B
			real T3 = Fl_I.Tt*100/180;
			real P3 = Fl_I.Pt*getUnitsFactor(Fl_I.Pt.units, "kPa");

			real a,b,c,d;
			a = 6.25528852e-08;
			b = -1.17064467e-04;
			c = 7.36953400e-02;
			d = -1.50392850e+01;
			EINOx = P3**0.4*(a*T3**3 + b*T3**2 + c*T3 +d)*FusEng.LHV/18400; //this applies a scaling if different fuels are used

		}

    }
    // ------------------------------
    // Turbine TrbH
    // ------------------------------
    Element Turbine TrbH
    {

		// ASK: again, why different PR and eff vals??
		// Why is MNdes not set??
		
		#include <hptCFM56.map>
		// a_effAud = 0.0;		
		//setOption("switchAud", "AUDIT");
		
		FlowStation F041;
		Fl_O.MNdes = 0.30;
		PRbase       = 3;
		effDes       = 0.888;
		// Turbine Cooling and Leakage Air (TCLA) stream 1 
		// (introduced at turbine inlet)
		InterStageBleedInPort TCLA_NC { 
			Pfract  = 1.0;
			diaPump = 0.0;
		} 
		
		// Turbine Cooling and Leakage Air (TCLA) stream 2 
		// (introduced at turbine exit)
		InterStageBleedInPort TCLA_CH { 
			Pfract  = 0.0;
			diaPump = 0.0;
		}
		
		// Subelement to calculate the amount of cooling flow required to cool the turbine	
		Subelement CoolIt Cool 
		{
			nStages = 1;
			bldNameFirstRow = "TCLA_NC";
			bldName = "TCLA_CH";
			TvaneDes[0] = 2000;
			TbladeDes[0] = 1900;
			s_BldFirstRow = 1.4;  
			s_Bld = 1.4;  
		}   

		void postexecute() 
		{ 
			F041.copyFlow("Fl_I");
			F041.add("TCLA_NC");
			if ( switchDes == "DESIGN" ) 
			{
				Cool.run();
			}
		}
	}
	// ------------------------------
	// End of Cust Bleed interstage
	// ------------------------------
	Element FlowEnd FeOBA
	{
	}
	// ------------------------------
	// End of Cust Bleed B
	// ------------------------------
	Element FlowEnd FeOBB
	{
	}	
	// ------------------------------
	// Shaft ShH
	// ------------------------------
	Element Shaft ShH
	{
		ShaftInputPort CmpH, TrbH;
		// ShaftOutputPort	PowerExtract;
		// Nmech = 15183.0;
		Nmech = 9000.0;
		// inertia = 10.0;
		// HPX = 550;
	}
	// ------------------------------
	// Horsepower Extraction
	// ------------------------------
	// Element CustomerPowerExtract CpwrH{
	// 	ShaftInputPort PowerRecieve;
	// 	setOption("switchPwr", "OFF");
	// 	pwr_in = 250;
	// 	}
	
	// ------------------------------	
	// Link Ports
	// ------------------------------
	// Fluid Ports
	linkPorts( "CmpH.Fl_O"        , "B030.Fl_I"       , "F030"  );
	linkPorts( "B030.Fl_O"        , "D031.Fl_I"       , "F031"  );
	linkPorts( "D031.Fl_O"        , "BrnPri.Fl_I"     , "F035"  );
	linkPorts( "BrnPri.Fl_O"      , "TrbH.Fl_I"       , "F040"  );
	// Bleed Connections
	linkPorts( "CmpH.Fl_B027"     , "FeOBA.Fl_I"      , "F027_OB"   );
	linkPorts( "B030.TCLA_NC"     , "TrbH.TCLA_NC"    , "TrbH_NC"   );
	linkPorts( "B030.TCLA_CH"     , "TrbH.TCLA_CH"    , "TrbH_CH"   );
	linkPorts( "B030.Fl_B030B"    , "FeOBB.Fl_I"      , "FB030B_OB" );
	// Fuel Linkage
	linkPorts( "FusEng.Fu_O"      , "BrnPri.Fu_I"      , "FuPri" );
	// Shaft Connections
	linkPorts( "CmpH.Sh_O"        , "ShH.CmpH"        , "MeCmpH"    );
	linkPorts( "TrbH.Sh_O"        , "ShH.TrbH"        , "MeTrbH"    );
	
	linkPorts( "ShH.PowerExtract" , "CpwrH.PowerRecieve", "power"     );
	
	promotePort( "CmpH.Fl_I", "Fl_I");
	promotePort( "TrbH.Fl_O", "Fl_O");
	// Promote the interstage bleed out ports so that they can be linked to the
	//  LPT in the main model file
	promotePort( "CmpH.Fl_B_CH", "LPT_CH");
	promotePort( "CmpH.Fl_B_NC", "LPT_NC");
	
	
	//Turbine cooling Bleeds
	// Independent ind_TCLA_NC_fracW { varName = "B030.TCLA_NC.fracW"; description = "Bleed flow"; }
	// Independent ind_TCLA_CH_fracW { varName = "B030.TCLA_CH.fracW"; description = "Bleed flow"; }
	// Dependent dep_CmpH_polyEff {eq_lhs = "CmpH.effPoly"; eq_rhs = "0.904";}
	
	// void variableChanged(string name, any oldval)
	// {
	// 	if (name == "switchDes")
	// 	{
	// 		if (switchDes == "DESIGN")
	// 		{
	// 			// in DESIGN mode, allow cycle changes such as engine flow and bypass ratio
	// 			Core.FusPri.ind_Wfuel.autoSetup  = TRUE;
				
	// 			Core.ind_TCLA_CH_fracW.autoSetup = FALSE;
	// 			Core.ind_TCLA_NC_fracW.autoSetup = FALSE;
				
	// 			Core.CmpH.ind_CmpH_eff.autoSetup = TRUE;
	// 			Core.dep_CmpH_polyEff.autoSetup  = TRUE;
	// 			ShH.HPX = 300;
	// 			CmpH.Fl_B027.fracBldW = 0.0445;
	// 		}
	// 		else
	// 		{
	// 			Core.FusPri.ind_Wfuel.autoSetup  = TRUE;
				
	// 			Core.ind_TCLA_CH_fracW.autoSetup = FALSE;
	// 			Core.ind_TCLA_NC_fracW.autoSetup = FALSE;
				
	// 			Core.CmpH.ind_CmpH_eff.autoSetup = FALSE;
	// 			Core.dep_CmpH_polyEff.autoSetup  = FALSE;
	// 			ShH.HPX = 0;
	// 			CmpH.Fl_B027.fracBldW = 0;
					
	// 		}
	// 	}
	// }

	

} //end Core